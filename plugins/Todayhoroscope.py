import random
from datetime import datetime

FORTUNE_CACHE = {}

TRIGGHT_KEYWORD = "Any"
HELP_MESSAGE = "今日运势 —> 查看你今日的运势信息" 

# 运势数据(可扩充)
LOCAL_FORTUNE_DATA = {
  "0": {
    "title": "渊厄（深渊级厄运）",
    "texts": [
      "黑云蔽日戾气生，妄动恐遭意外横\n谨言慎行守斋戒，静待阳升化七成",
      "天狗食月乱神魂，钱财饮食需谨慎\n黄庭静诵三百字，仙真或可护命门",
      "六爻俱凶血光随，大事缓决病速医\n幸有东北贵人至，赠符解围破危机"
    ]
  },
  "1": {
    "title": "坎陷（坎卦级险境）",
    "texts": [
      "如履薄冰暗流藏，投资情爱需明辨\n玄武暗中施庇佑，慎终如始可渡关",
      "迷雾锁江小人生，文书反复戌时成\n佩玉挡灾引紫气，运程渐明见转机",
      "卷舌星动惹风波，晨拜朱雀化灾厄\n戌狗属相暗相助，谋略得当转危安"
    ]
  },
  "2": {
    "title": "陷厄（沉陷级困局）",
    "texts": [
      "丧门照命忌远行，卯辰慎防无名盟\n戌狗赠赤玉髓佩，可挡灾星破阴霾",
      "病符侵体饮食忌，西南莫留锁元气\n亥时焚艾净宅后，天医祛病运势起",
      "勾陈缠身流言穿，巳未慎言钱财缘\n正东青衫老者现，指点迷津解困玄"
    ]
  },
  "3": {
    "title": "蹇难（蹇卦级阻滞）",
    "texts": [
      "天罗地网藏刀锋，决策延七情装聋\n午时面西拜白虎，铜铃三响破樊笼",
      "五鬼运财反噬凶，子寅紧闭防邪祟\n速请桃木刻鼠相，置于乾位镇厄空",
      "驿马倒悬行路难，五谷随身井卦言\n东北双鹊忽起舞，便是厄尽祥瑞显"
    ]
  },
  "4": {
    "title": "中正（平衡之境）",
    "texts": [
      "阴阳和合运道平，守成持泰即功成\n虹霓贯东西时现，静待良机自有凭",
      "太极流转最安然，晨练卯时投土性\n故人忽传佳讯至，笑谈往昔续前缘",
      "星斗循轨循旧例，创新三思传机遇\n酉时双燕飞掠过，吉兆天机暗中藏"
    ]
  },
  "5": {
    "title": "渐吉（渐进式祥兆）",
    "texts": [
      "三合局开旧债清，辰种财竹申小投\n红鸾初现含蓄应，运道渐开新财流",
      "文昌照曲正当时，朱砂点额增灵智\n西方捧书客偶遇，三问玄机得妙思",
      "玉堂贵人消恩怨，失物重现巽位显\n酉时备酒待客至，商机卦图暗中现"
    ]
  },
  "6": {
    "title": "通明（通达级吉运）",
    "texts": [
      "禄存高照财门开，巳午投资翻番来\n分润马姓保长久，冷灶贵人送柴财",
      "驿马星动利远行，航班6/8最显灵\n异国鼠辈街头遇，竟是关键引路人",
      "天解星消法律业，文件三份印震歇\n亥时雨落洗净尘，新契前路自此开"
    ]
  },
  "7": {
    "title": "鼎盛（巅峰级鸿运）",
    "texts": [
      "天乙贵人万事成，寅祭未提获重金\n双鱼跃门速购彩，所求皆得称人心",
      "将星坐镇展峥嵘，青绿战袍攻西锋\n戌时犬吠捷报至，竞技场上定输赢",
      "帝旺当头敢争锋，午地申科利不同\n分羹兔姓避亏空，盛极运道贯长虹"
    ]
  },
  "8": {
    "title": "太和（终极祥瑞）",
    "texts": [
      "紫微开天门献瑞，三奇六合共相随\n功名正当九天月，鸾凤和鸣非梦哉",
      "河图洛书天降财，跨国冷门翻倍来\n红鸾星动良缘至，地涌甘泉金玉伴",
      "青龙盘柱文武彰，学术竞技破旧章\n亥子异梦先祖指，迷津得解镇八方"
    ]
  },
  "9": {
    "title": "昌盛（昌隆级盛运）",
    "texts": [
      "旭日东升万丈光，财源广进福满堂\n东南贵人相助力，事业腾达不可挡",
      "吉星高照喜事连，婚姻美满子孙贤\n投资理财有收获，身体健康寿延年",
      "文昌照耀智慧开，考试竞赛皆成功\n官运亨通步步升，社会地位日增高"
    ]
  },
  "10": {
    "title": "福寿（福寿级安康）",
    "texts": [
      "福星高照寿绵长，起居有节保安康\n晨练卯时吸清气，百病不侵体强健",
      "子孙满堂乐融融，家宅平安运道通\n慈善积德增福报，晚年幸福似仙翁",
      "东南方见寿桃现，亥时静坐养心神\n偶得古籍养生法，延年益寿妙无穷"
    ]
  },
  "11": {
    "title": "如意（如意级吉兆）",
    "texts": [
      "心想事成如意转，所求皆得无阻碍\n午时面南许愿望，三日之内见成效",
      "玉如意摆乾位安，财运亨通喜讯来\n旧友重逢结新盟，合作项目成功开",
      "梦中仙人指迷津，醒后行动获成功\n酉时购得幸运物，随身佩戴运道增"
    ]
  },
  "12": {
    "title": "吉祥（吉祥级瑞应）",
    "texts": [
      "瑞气千条吉祥照，万事如意福临门\n辰时见喜鹊鸣叫，当日必有好事成",
      "麒麟送子入家门，子女聪慧前途明\n学业有成事业兴，家族荣耀代代传",
      "吉祥符咒贴门楣，邪祟远离保平安\n戌时焚香拜天地，家宅兴旺人和谐"
    ]
  },
  "13": {
    "title": "鸿福（鸿福级天佑）",
    "texts": [
      "天佑鸿福运道昌，大事小情皆顺遂\n寅时祭天获庇佑，事业突破创新高",
      "鸿雁传书佳音至，远方贵人助成功\n国际合作机会多，财富积累如潮涌",
      "福如东海寿如山，健康长寿乐逍遥\n日常行善积阴德，后代子孙享余荫"
    ]
  },
  "14": {
    "title": "康宁（康宁级和平）",
    "texts": [
      "康宁安稳度日辰，家庭和睦无纷争\n卯时静坐养心性，内外和谐运道平",
      "身体健康精神爽，小病小痛自消退\n饮食清淡作息律，长生之道在其中",
      "邻里友善互助多，社区和谐共发展\n酉时散步遇良师，指点人生获智慧"
    ]
  },
  "15": {
    "title": "泰来（泰来级转机）",
    "texts": [
      "否极泰来运道转，昔日困境今突破\n辰时行动获转机，事业生活双丰收",
      "泰山压顶不弯腰，坚持到底成功来\n贵人相助解危难，未来道路更宽广",
      "投资理财逢时机，亏损项目翻盘赢\n戌时得消息利好，财富增长可预期"
    ]
  },
  "16": {
    "title": "丰盈（丰盈级富足）",
    "texts": [
      "五谷丰登财源广，衣食无忧生活富\n巳时购物遇折扣，节省开支积财富",
      "仓库充实库存足，生意兴隆客似云\n合作项目利润厚，财富积累稳如山",
      "精神丰盈智慧开，读书学习有收获\n酉时参加讲座会，灵感迸发创新业"
    ]
  },
  "17": {
    "title": "顺遂（顺遂级顺利）",
    "texts": [
      "一帆风顺事事成，无波无折达目标\n午时出发旅行吉，一路平安快乐多",
      "人际关系和谐顺，同事朋友相助勤\n项目推进无阻碍，提前完成获赞赏",
      "情感道路平坦行，单身遇缘已婚稳\n戌时约会浪漫增，感情升温幸福长"
    ]
  },
  "18": {
    "title": "辉煌（辉煌级成就）",
    "texts": [
      "辉煌成就耀人眼，事业巅峰获荣誉\n寅时领奖受表彰，社会地位大幅升",
      "学业有成金榜题，名校录取未来明\n研究成果突破性，学术领域占鳌头",
      "艺术创作获好评，展览演出成功举\n酉时收到邀请函，国际舞台展才华"
    ]
  },
  "19": {
    "title": "鼎革（鼎革级革新）",
    "texts": [
      "鼎革革新破旧立，改革创新成功机\n辰时启动新项目，技术突破市场占",
      "传统行业转型顺，拥抱变化获红利\n戌时会议定战略，未来方向明确清",
      "个人成长蜕变快，学习新技能提升\n酉时遇导师指点，职业生涯新篇章"
    ]
  },
  "20": {
    "title": "升华（升华级提升）",
    "texts": [
      "升华提升境界高，精神物质双丰收\n午时冥想悟真理，人生观念大变样",
      "技能水平突飞进，考核认证轻松过\n职位晋升薪资涨，社会认可度增加",
      "情感关系深化和，家庭幸福指数升\n戌时谈心解误会，关系更紧密和谐"
    ]
  },
  "21": {
    "title": "无极（无极级无限）",
    "texts": [
      "无极无限可能开，创意迸发机会多\n寅时灵感如泉涌，新项目启动成功",
      "财富增长无上限，投资回报倍数翻\n辰时收到意外财，理财计划超额完",
      "健康状态极佳好，运动表现破记录\n酉时体检指标优，长寿可期乐悠悠"
    ]
  },
  "22": {
    "title": "玄同（玄同级合一）",
    "texts": [
      "玄同合一境界深，天人合一道理明\n午时静坐感天地，智慧顿悟烦恼消",
      "与自然和谐共处，环保行动获福报\n戌时散步观星空，心灵平静喜悦生",
      "人际关系融和洽，冲突化解共识达\n酉时聚会交流深，友谊巩固合作成"
    ]
  },
  "23": {
    "title": "洞明（洞明级智慧）",
    "texts": [
      "洞明智慧洞察深，问题解决轻松易\n辰时读书理解快，知识应用灵活现",
      "决策准确无失误，事业方向选择对\n戌时思考策略定，未来规划清晰明",
      "看人看事透本质，避免陷阱抓住机\n酉时交谈获真知，人生指导价值高"
    ]
  },
  "24": {
    "title": "飞升（飞升级超越）",
    "texts": [
      "飞升超越极限破，成就非凡令人羡\n寅时突破自我限，新纪录创造历史",
      "事业飞黄腾达快，行业领袖地位固\n辰时签约大项目，利润丰厚名声扬",
      "精神飞升觉悟高，修行得道智慧开\n酉时参禅悟真理，生命意义深刻明"
    ]
  },
  "25": {
    "title": "逍遥（逍遥级自在）",
    "texts": [
      "逍遥自在无约束，生活随心快乐多\n午时旅行自由行，风景人文享受足",
      "财务自由时间裕，做喜欢事无压力\n戌时 hobbies 发展，技能兴趣双提升",
      "人际关系轻松处，无拘无束真情流\n酉时聚会畅谈欢，心灵满足幸福满"
    ]
  },
  "26": {
    "title": "圆满（圆满级完美）",
    "texts": [
      "圆满完美无缺憾，事业家庭双丰收\n辰时庆典庆成就，亲友祝贺乐融融",
      "健康财富情感满，人生目标皆达成\n戌时回顾人生路，感恩满足喜悦生",
      "精神圆满觉悟高，智慧慈悲兼具备\n酉时静思感宇宙，和谐一体永恒存"
    ]
  },
  "27": {
    "title": "永恒（永恒级持久）",
    "texts": [
      "永恒持久运道稳，好运长伴不衰退\n寅时定长期计划，未来十年皆顺利",
      "财富积累可持续，投资稳健收益长\n辰时布局遗产规，子孙后代享福泽",
      "健康长寿体强健，生活习惯保持好\n酉时锻炼坚持做，百年无忧乐逍遥"
    ]
  },
  "28": {
    "title": "天启（天启级启示）",
    "texts": [
      "天启启示智慧开，宇宙真理顿悟明\n午时感应天象变，人生方向大调整",
      "灵感爆发创新多，发明创造改变世\n戌时梦得神谕指，项目成功影响深",
      "道德提升行为正，社会贡献获赞誉\n酉时慈善行动广，福报积累永恒存"
    ]
  },
  "29": {
    "title": "太一（太一级本源）",
    "texts": [
      "太一本源道之根，万物归一运道极\n寅时冥想连宇宙，能量充满身心健",
      "财富无限源不断，公益慈善反馈多\n辰时见太极图案，生意兴隆通四海",
      "生命永恒精神耀，传承智慧启后人\n酉时观星悟天道，人生圆满归太一"
    ]
  }
}

def get_local_fortune(user_qq):
    today_str = datetime.now().strftime("%Y-%m-%d")
    cache_key = (user_qq, today_str)

    # 1. 检查缓存
    if cache_key in FORTUNE_CACHE:
        title, text = FORTUNE_CACHE[cache_key]
    else:
        # 2. 缓存中没有，生成新运势
        key = str(random.randint(0, 8))
        fortune_level = LOCAL_FORTUNE_DATA[key]
        
        title = fortune_level["title"]
        text = random.choice(fortune_level["texts"])
        
        # 写入缓存
        FORTUNE_CACHE[cache_key] = (title, text)

    # 3. 格式化输出
    fortune_text = (
        f"【运势等级】: {title}\n"
        f"【签文】: {text}"
    )
    return fortune_text


async def on_message(event, actions, Manager, Segments):
    full_msg = str(event.message).strip()
    
    if full_msg != "今日运势":
        return False
    
    user_qq = getattr(event, "user_id", None)

    if not user_qq:
        await actions.send(
            group_id=getattr(event, "group_id", None) or getattr(event, "user_id", None),
            message=Manager.Message(Segments.Text("获取用户ID失败，无法查询运势。"))
        )
        return True

    fortune_text = get_local_fortune(user_qq)
    image_url = "https://pic.mcxclr.top"

    footer = "仅供娱乐｜相信科学｜请勿迷信"

    at_segment = Segments.At(user_qq)

    parts = [
        at_segment,
        Segments.Text(" 🎲 今日运势：\n"),
        Segments.Text(f"{fortune_text}\n\n"),
        Segments.Image(image_url),
        Segments.Text("\n" + footer)
    ]

    await actions.send(
        group_id=getattr(event, "group_id", None) or getattr(event, "user_id", None),
        message=Manager.Message(*parts)
    )
    return True
